// Optimized Prisma schema for better performance and readability.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Member {
  id           String              @id @default(auto()) @map("_id") @db.ObjectId
  firstName    String
  lastName     String?
  username     String              @unique
  phone        String?
  email        String?
  avatar       String?
  joinedAt     DateTime            @default(now())
  active       Boolean             @default(true)
  vendors      Vendor[]            @relation("OwnerVendors")
  profitShares VendorProfitShare[]
  passbook     Passbook            @relation(fields: [passbookId], references: [id], onDelete: Cascade)
  passbookId   String              @unique @db.ObjectId
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  transactions Transaction[]
}

model Vendor {
  id           String              @id @default(auto()) @map("_id") @db.ObjectId
  name         String
  slug         String              @unique
  type         VENDOR_TYPE         @default(DEFAULT)
  terms        Float               @default(0)
  termType     PERIOD              @default(NONE)
  startAt      DateTime            @default(now())
  endAt        DateTime?
  active       Boolean             @default(true)
  owner        Member?             @relation("OwnerVendors", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerId      String?             @db.ObjectId
  ownerRole    MEMBER_VENDOR_ROLE  @default(DEFAULT)
  profitShares VendorProfitShare[]
  passbook     Passbook            @relation(fields: [passbookId], references: [id], onDelete: Cascade)
  passbookId   String              @unique @db.ObjectId
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  transactions Transaction[]
}

model Transaction {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  amount          Float              @default(0)
  transactionType TRANSACTION_TYPE   @default(PERIODIC_DEPOSIT)
  transactionAt   DateTime           @default(now())
  method          TRANSACTION_METHOD @default(ACCOUNT)
  vendor          Vendor             @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId        String             @db.ObjectId
  member          Member             @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId        String             @db.ObjectId
  note            String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model VendorProfitShare {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  vendorId  String   @db.ObjectId
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  memberId  String   @db.ObjectId
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Passbook {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  type        PASSBOOK_TYPE @default(VENDOR)
  periodIn    Float         @default(0)
  offsetIn    Float         @default(0)
  in          Float         @default(0)
  out         Float         @default(0)
  loanOffset  Float         @default(0)
  offset      Float         @default(0)
  returns     Float         @default(0)
  terms       Float         @default(0)
  currentTerm Float         @default(0)
  calcReturns Boolean       @default(true)
  balance     Float         @default(0)
  fund        Float         @default(0)
  recentDate  DateTime?
  lastDate    DateTime?
  addon       Json?
  member      Member?
  vendor      Vendor?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

enum VENDOR_TYPE {
  DEFAULT
  HOLD
  CHIT
  LEND
  BANK
}

enum TRANSACTION_METHOD {
  CASH
  ACCOUNT
  UPI
  BANK
  CHEQUE
}

enum TRANSACTION_TYPE {
  PERIODIC_DEPOSIT
  OFFSET_DEPOSIT
  WITHDRAW
  REJOIN
  FUNDS_TRANSFER
  INVEST
  RETURNS
  PROFIT
}

enum MEMBER_VENDOR_ROLE {
  DEFAULT
  MEDIATOR
  SELF
}

enum PASSBOOK_TYPE {
  MEMBER
  VENDOR
  CLUB
}

enum PERIOD {
  NONE
  DAY
  WEEK
  MONTH
  YEAR
}
