// Optimized Prisma schema for better performance and readability.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum ROLE {
  SUPER_ADMIN
  ADMIN
  MEMBER
}

model Account {
  id                  String        @id @default(auto()) @map("_id") @db.ObjectId
  firstName           String
  lastName            String?
  // Auth
  username            String        @unique // for login (required, unique)
  email               String? // for login (enforce uniqueness in app logic for non-null values)
  passwordHash        String? // bcrypt hash; null for vendor-only accounts
  // Access control
  role                ROLE          @default(MEMBER)
  readAccess          Boolean       @default(true)
  writeAccess         Boolean       @default(false)
  canLogin            Boolean       @default(false)
  // Audit fields for access control
  accessUpdatedAt     DateTime?
  accessUpdatedBy     String?       @db.ObjectId
  phone               String?
  avatar              String?
  startAt             DateTime      @default(now())
  endAt               DateTime?
  active              Boolean       @default(true)
  isMember            Boolean       @default(true)
  passbook            Passbook      @relation(fields: [passbookId], references: [id], onDelete: Cascade)
  passbookId          String        @unique @db.ObjectId
  fromTransaction     Transaction[] @relation("FromAccount")
  toTransaction       Transaction[] @relation("ToAccount")
  // Audit relations
  createdTransactions Transaction[] @relation("CreatedBy")
  updatedTransactions Transaction[] @relation("UpdatedBy")
  lastLoginAt         DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

model Transaction {
  id              String             @id @default(auto()) @map("_id") @db.ObjectId
  amount          Float              @default(0)
  transactionType TRANSACTION_TYPE   @default(PERIODIC_DEPOSIT)
  transactionAt   DateTime           @default(now())
  method          TRANSACTION_METHOD @default(ACCOUNT)
  from            Account            @relation("FromAccount", fields: [fromId], references: [id], onDelete: Cascade)
  fromId          String             @db.ObjectId
  to              Account            @relation("ToAccount", fields: [toId], references: [id], onDelete: Cascade)
  toId            String             @db.ObjectId
  // Audit trail
  createdBy       Account?           @relation("CreatedBy", fields: [createdById], references: [id])
  createdById     String?            @db.ObjectId
  updatedBy       Account?           @relation("UpdatedBy", fields: [updatedById], references: [id])
  updatedById     String?            @db.ObjectId
  note            String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model Passbook {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  type          PASSBOOK_TYPE @default(VENDOR)
  // Financial Data (stored as JSON for flexibility)
  // For MEMBER: periodicDepositAmount, offsetDepositAmount, accountBalance, etc.
  // For VENDOR: totalInvestment, totalReturns, totalProfitAmount
  // For CLUB: clubHeldAmount, currentClubBalance, netClubBalance, etc.
  payload       Json          @default("{}")
  // Loan History (array of loan records with dates and amounts)
  loanHistory   Json          @default("[]")
  // Adjustments
  joiningOffset Float         @default(0) // Late join adjustment amount
  delayOffset   Float         @default(0) // Delayed payment adjustment amount
  // Configuration
  isChit        Boolean       @default(true) // Whether this passbook is for chit/club operations
  // Relations
  account       Account?
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([type])
}

enum TRANSACTION_METHOD {
  CASH
  ACCOUNT
  UPI
  BANK
  CHEQUE
}

enum TRANSACTION_TYPE {
  PERIODIC_DEPOSIT
  OFFSET_DEPOSIT
  WITHDRAW
  REJOIN
  FUNDS_TRANSFER
  VENDOR_INVEST
  VENDOR_RETURNS
  LOAN_TAKEN
  LOAN_REPAY
  LOAN_INTEREST
}

enum PASSBOOK_TYPE {
  MEMBER
  VENDOR
  CLUB
}

model Summary {
  id                     String   @id @default(auto()) @map("_id") @db.ObjectId
  monthStartDate         DateTime
  monthEndDate           DateTime
  // Members
  activeMembers          Int      @default(0)
  clubAgeMonths          Int      @default(0)
  // Member Funds
  totalDeposits          Float    @default(0)
  memberBalance          Float    @default(0)
  // Member Outflow
  profitWithdrawals      Float    @default(0)
  memberAdjustments      Float    @default(0)
  // Loans - Lifetime
  totalLoanGiven         Float    @default(0)
  totalInterestCollected Float    @default(0)
  // Loans - Active / Outstanding
  currentLoanTaken       Float    @default(0)
  interestBalance        Float    @default(0)
  // Vendor
  vendorInvestment       Float    @default(0)
  vendorProfit           Float    @default(0)
  // Cash Flow
  totalInvested          Float    @default(0)
  pendingAmounts         Float    @default(0)
  // Valuation
  availableCash          Float    @default(0)
  currentValue           Float    @default(0)
  // Portfolio
  totalPortfolioValue    Float    @default(0)
  // System
  recalculatedAt         DateTime @default(now())
  recalculatedByAdminId  String?  @db.ObjectId
  isLocked               Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@unique([monthStartDate])
  @@index([monthEndDate])
}
